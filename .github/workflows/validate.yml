name: Validate Examples

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install pyyaml httpx

      - name: Validate mcp.yaml schemas
        run: |
          python -c "
          import yaml
          import sys
          from pathlib import Path

          examples = ['hello-tools', 'hello-filesystem']

          for example in examples:
              config_path = Path(example) / 'mcp.yaml'
              with open(config_path) as f:
                  config = yaml.safe_load(f)

              # Check required fields
              assert 'schema_version' in config, f'{example}: Missing schema_version'
              assert 'registry' in config, f'{example}: Missing registry'
              assert 'ref' in config['registry'], f'{example}: Missing registry.ref'

              # Fail if pinned to main (not reproducible)
              ref = config['registry']['ref']
              if ref == 'main':
                  print(f'ERROR: {example}/mcp.yaml registry.ref is \"main\" - pin to a tagged release')
                  sys.exit(1)

              print(f'âœ“ {example}/mcp.yaml valid (ref: {ref})')
          "

      - name: Test echo tool
        working-directory: hello-tools
        run: |
          python -m tools.echo.main "CI test"
          python -m tools.echo.main --uppercase "ci test"

      - name: Test http-get stub mode
        working-directory: hello-tools
        run: |
          python -m tools.http_get.main https://example.com | grep -q "STUB MODE"

      - name: Test http-get real mode
        working-directory: hello-tools
        env:
          ALLOW_NETWORK: "1"
        run: |
          python -m tools.http_get.main https://httpbin.org/get | grep -q "REAL MODE"

      # hello-filesystem tests
      - name: Test file_write stub mode
        working-directory: hello-filesystem
        run: |
          python -m tools.file_write.main test.txt "content" | grep -q "STUB MODE"

      - name: Test file_write sandbox mode
        working-directory: hello-filesystem
        env:
          ALLOW_WRITE: "1"
        run: |
          python -m tools.file_write.main test.txt "sandbox content" | grep -q "SANDBOX MODE"
          test -f sandbox/test.txt
          rm sandbox/test.txt

      - name: Test file_write path restriction
        working-directory: hello-filesystem
        env:
          ALLOW_WRITE: "1"
        run: |
          python -m tools.file_write.main "../../../evil.txt" "should be sandboxed"
          test -f sandbox/evil.txt
          rm sandbox/evil.txt
